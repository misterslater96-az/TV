#!/usr/bin/env bash
set -e

echo ">>> FreeVee OS (TV 4.0) builder starting..."
echo ">>> WARNING: This is for a VM / test install ONLY."

if ! command -v apt >/dev/null 2>&1; then
  echo "This requires an apt-based system (Mint/Ubuntu)."
  exit 1
fi

USERNAME="$USER"

########################################
# 0. BASIC CHECKS
########################################
if [ "$EUID" -eq 0 ]; then
  echo "Run this as your normal user, NOT root (sudo will be used as needed)."
  exit 1
fi

echo ">>> Updating package list..."
sudo apt update

########################################
# 1. INSTALL CORE PACKAGES
########################################
echo ">>> Installing core packages (openbox, tint2, terminals, drivers, snapshot tools)..."

sudo apt install -y \
  openbox tint2 \
  xterm lxterminal \
  network-manager-gnome \
  mpv curl xmlstarlet ffmpeg \
  ubuntu-drivers-common linux-firmware \
  squashfs-tools xorriso isolinux syslinux-utils genisoimage \
  imagemagick

# Optional extra WiFi blobs (best-effort; not exhaustive)
sudo apt install -y \
  firmware-b43-installer \
  firmware-realtek || true

########################################
# 1A. CREATE BOOT SPLASH IMAGE (READ-ONLY)
########################################
echo ">>> Creating boot splash image at ~/boot.png ..."
if [ ! -f "$HOME/boot.png" ]; then
  convert -size 1024x768 xc:black \
    -gravity center -pointsize 48 -fill white \
    -annotate 0 "FreeVee OS" \
    "$HOME/boot.png"
  chmod 444 "$HOME/boot.png"
else
  chmod 444 "$HOME/boot.png" || true
fi

########################################
# 2. PLACEHOLDER: ENSURE TV 3.0 INSTALLED
########################################
echo
echo ">>> NOTE:"
echo "This script assumes you already have 'tv' (TV 3.0) installed and working."
echo "If not, run your TV 3.0 installer first, then re-run this builder."
echo

if ! command -v tv >/dev/null 2>&1; then
  echo ">>> 'tv' command not found. FreeVee shell will still be wired, but TV won't start."
  echo ">>> You can install TV 3.0 later, and the shell will pick it up."
fi

########################################
# 3. CREATE FREEVEE USER SHELL
########################################
echo ">>> Creating FreeVee TV shell wrapper..."

mkdir -p "$HOME/.local/bin"

cat > "$HOME/.local/bin/freevee-tv-shell" << 'EOF'
#!/usr/bin/env bash
# FreeVee TV shell: loops tv forever in a terminal

while true; do
  # Use a simple terminal; you can swap lxterminal/xterm/kitty/etc.
  lxterminal -e bash -lc 'tv; exec bash'
  sleep 1
done
EOF

chmod +x "$HOME/.local/bin/freevee-tv-shell"

########################################
# 4. OPENBOX + TINT2 MINIMAL SESSION
########################################
echo ">>> Configuring Openbox + Tint2 minimal FreeVee session..."

mkdir -p "$HOME/.config/openbox"
mkdir -p "$HOME/.config/tint2"

# Openbox autostart: start tint2 and our TV shell
cat > "$HOME/.config/openbox/autostart" << 'EOF'
tint2 &
~/.local/bin/freevee-tv-shell &
EOF

# Very minimal Openbox rc.xml (no window decorations, keep it simple)
cat > "$HOME/.config/openbox/rc.xml" << 'EOF'
<?xml version="1.0" encoding="UTF-8"?>
<openbox_config xmlns="http://openbox.org/3.4/rc">
  <theme>
    <name>Clearlooks</name>
  </theme>
  <desktops>
    <number>1</number>
  </desktops>
  <focus>
    <focusNew>yes</focusNew>
  </focus>
  <placement>
    <policy>UnderMouse</policy>
  </placement>
</openbox_config>
EOF

########################################
# 5. TINT2 PANEL WITH SIX ICONS
########################################
echo ">>> Creating tint2 panel with 6 icons..."

cat > "$HOME/.config/tint2/tint2rc" << 'EOF'
# Minimal tint2 panel in bottom center with 6 launchers
panel_items = L
panel_monitor = all
panel_position = bottom center horizontal
panel_size = 80% 36
panel_margin = 0 0
panel_padding = 2 2 2
font_shadow = 0

launcher_item_app = nm-applet.desktop
launcher_item_app = nemo.desktop
launcher_item_app = mpv.desktop
launcher_item_app = org.gnome.Terminal.desktop
launcher_item_app = freevee-shutdown.desktop

EOF

########################################
# 6. CUSTOM DESKTOP ENTRIES FOR PANEL
########################################
echo ">>> Creating custom desktop entries for FreeVee launchers..."

mkdir -p "$HOME/.local/share/applications"

# Shutdown launcher
cat > "$HOME/.local/share/applications/freevee-shutdown.desktop" << 'EOF'
[Desktop Entry]
Type=Application
Name=Shutdown
Exec=systemctl poweroff
Icon=system-shutdown
Terminal=false
Categories=System;
EOF

# Ensure panel sees local apps
update-desktop-database "$HOME/.local/share/applications" 2>/dev/null || true

########################################
# 7. AUTOLOGIN INTO OPENBOX SESSION
########################################
echo ">>> Configuring LightDM autologin into Openbox..."

if [ -f /etc/lightdm/lightdm.conf.d/90-linuxmint.conf ]; then
  LDM_CFG="/etc/lightdm/lightdm.conf.d/90-linuxmint.conf"
elif [ -f /etc/lightdm/lightdm.conf ]; then
  LDM_CFG="/etc/lightdm/lightdm.conf"
else
  LDM_CFG=""
fi

if [ -n "$LDM_CFG" ]; then
  sudo bash -c "cat > '$LDM_CFG'" << EOF
[Seat:*]
autologin-user=$USERNAME
autologin-user-timeout=0
user-session=openbox
greeter-session=slick-greeter
EOF
  echo ">>> LightDM autologin configured for user '$USERNAME' into Openbox."
else
  echo ">>> LightDM config not found; autologin not configured. You may need to adjust manually."
fi

########################################
# 8. OPTIONAL: REMOVE BIG DESKTOP META-PACKAGES
########################################
echo ">>> Optionally removing Cinnamon meta-packages to slim down (safe-ish in VM)..."

sudo apt remove -y \
  cinnamon-desktop-environment mint-meta-cinnamon || true

sudo apt autoremove -y || true

########################################
# 9. BOOT-TIME DRIVER AUTOINSTALL SERVICE
########################################
echo ">>> Creating boot-time driver auto-install service (best effort)..."

sudo bash -c 'cat > /etc/systemd/system/freevee-drivers.service' << 'EOF'
[Unit]
Description=FreeVee first-boot driver autoinstall
After=network-online.target

[Service]
Type=oneshot
ExecStart=/usr/bin/bash -lc "ubuntu-drivers autoinstall || true"
ExecStart=/usr/bin/bash -lc "touch /var/lib/freevee-drivers-done"
ConditionPathExists=!/var/lib/freevee-drivers-done

[Install]
WantedBy=multi-user.target
EOF

sudo systemctl daemon-reload
sudo systemctl enable freevee-drivers.service || true

########################################
# 10. SNAPSHOT PREP (AUTO ISO STEP)
########################################
echo ">>> Preparing tools to snapshot this VM into an ISO..."

# Snapshot tool: creates a FreeVee OS ISO into the given directory (default: $HOME)
sudo bash -c 'cat > /usr/local/bin/freevee-make-iso' << 'EOF'
#!/usr/bin/env bash
set -e

OUTDIR=${1:-$HOME}
OUTISO="$OUTDIR/freevee-os-$(date +%Y%m%d).iso"

echo ">>> Creating FreeVee OS ISO at: $OUTISO"
echo ">>> This is a simple snapshot of the current root filesystem."

WORKDIR=$(mktemp -d)
trap 'rm -rf "$WORKDIR"' EXIT

ROOTFS="$WORKDIR/rootfs"
ISO_ROOT="$WORKDIR/iso"

mkdir -p "$ROOTFS" "$ISO_ROOT/live"

echo ">>> Copying filesystem (this can take a while)..."
sudo rsync -aAX /* "$ROOTFS" \
  --exclude="$WORKDIR" \
  --exclude=/proc/* \
  --exclude=/sys/* \
  --exclude=/dev/* \
  --exclude=/run/* \
  --exclude=/tmp/* \
  --exclude=/mnt/* \
  --exclude=/media/* \
  --exclude=/lost+found

echo ">>> Creating squashfs..."
mksquashfs "$ROOTFS" "$ISO_ROOT/live/filesystem.squashfs" -e boot

echo ">>> Copying kernel and initrd..."
sudo cp -a /boot/vmlinuz* "$ISO_ROOT/live/vmlinuz"
sudo cp -a /boot/initrd* "$ISO_ROOT/live/initrd"

echo ">>> Creating basic isolinux config..."
mkdir -p "$ISO_ROOT/isolinux"

# Copy syslinux/isolinux binaries
if [ -f /usr/lib/ISOLINUX/isolinux.bin ]; then
  cp /usr/lib/ISOLINUX/isolinux.bin "$ISO_ROOT/isolinux/"
fi
if [ -f /usr/lib/syslinux/modules/bios/menu.c32 ]; then
  cp /usr/lib/syslinux/modules/bios/menu.c32 "$ISO_ROOT/isolinux/"
fi

# Copy boot splash if present
if [ -f /home/'"$USERNAME"'/boot.png ]; then
  cp /home/'"$USERNAME"'/boot.png "$ISO_ROOT/isolinux/boot.png"
  BG_LINE="MENU BACKGROUND boot.png"
else
  BG_LINE=""
fi

cat > "$ISO_ROOT/isolinux/isolinux.cfg" << EOT
UI menu.c32
PROMPT 0
MENU TITLE FreeVee OS Boot Menu
TIMEOUT 50
$BG_LINE

LABEL freevee
  MENU LABEL FreeVee OS (Live)
  KERNEL /live/vmlinuz
  APPEND initrd=/live/initrd boot=live
EOT

echo ">>> Building ISO (xorriso)..."
xorriso -as mkisofs \
  -iso-level 3 \
  -full-iso9660-filenames \
  -volid "FREEVEE_OS" \
  -output "$OUTISO" \
  -isohybrid-mbr /usr/lib/ISOLINUX/isohdpfx.bin \
  -c isolinux/boot.cat \
  -b isolinux/isolinux.bin \
    -no-emul-boot -boot-load-size 4 -boot-info-table \
  "$ISO_ROOT"

echo ">>> Done. ISO created at: $OUTISO"
EOF

sudo chmod +x /usr/local/bin/freevee-make-iso

########################################
# 11. AUTO-RUN ISO CREATION ON NEXT BOOT
########################################
echo ">>> Creating systemd service to auto-build ISO on next boot..."

sudo bash -c "cat > /etc/systemd/system/freevee-make-iso-onboot.service" << EOF
[Unit]
Description=FreeVee OS ISO one-time builder
After=multi-user.target

[Service]
Type=oneshot
ExecStart=/usr/bin/bash -lc '/usr/local/bin/freevee-make-iso /home/$USERNAME'
ExecStartPost=/usr/bin/touch /var/lib/freevee-iso-built
ConditionPathExists=!/var/lib/freevee-iso-built

[Install]
WantedBy=multi-user.target
EOF

sudo systemctl daemon-reload
sudo systemctl enable freevee-make-iso-onboot.service || true

########################################
# DONE
########################################
echo
echo "===================================================="
echo " FreeVee OS (TV 4.0) builder finished."
echo
echo " NEXT STEPS:"
echo "  - System will now reboot."
echo "  - On next boot, it will auto-login into FreeVee shell (Openbox+tint2+TV)."
echo "  - In the background, it will automatically build a bootable ISO"
echo "    into: /home/$USERNAME/freevee-os-YYYYMMDD.iso"
echo "  - After that, you can extract the ISO via VM shared folders"
echo "    and flash it to a USB drive with Balena Etcher."
echo "===================================================="
echo "Rebooting now..."
sudo reboot
